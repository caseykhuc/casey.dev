---
title: "Code splitting and lazy loading for frontend performance"
dateString: "June 05, 2024"
tags: ["webdev", "frontend"]
---

Cáº£ 2 khÃ¡i niá»‡m nÃ y cá»§a phÃ¡t triá»ƒn web Ä‘á»u cÃ³ cÃ¡i tÃªn ráº¥t dá»… hÃ¬nh dung, tuy nhiÃªn sá»­ dá»¥ng chÃºng trong thá»±c táº¿ tháº¿ nÃ o thÃ¬ Ä‘Ã´i khi váº«n cÃ²n gÃ¢y nháº§m láº«n. HÃ´m nay mÃ¬nh sáº½ láº¥y vÃ­ dá»¥ Ä‘Æ¡n giáº£n Ä‘á»ƒ minh hoáº¡ 2 khÃ¡i niá»‡m nhÃ©:

## Code splitting

[***Code splitting***](https://developer.mozilla.org/en-US/docs/Glossary/Code_splitting) cÃ³ nghÄ©a lÃ  xáº» (split) Ä‘oáº¡n code - mÃ  phá»• biáº¿n nháº¥t lÃ  code javascript - thÃ nh nhiá»u máº£nh (chunk) nhá», nháº±m cáº£i thiá»‡n ***thá»i gian táº£i trang ban Ä‘áº§u***.

Vá»›i Frontend development hiá»‡n Ä‘áº¡i, source code vÃ  third-party dependencies thÆ°á»ng Ä‘Æ°á»£c bundle (Ä‘Ã³ng gÃ³i) láº¡i thÃ nh file Javascript duy nháº¥t. Vá»›i má»™t Single-page application Ä‘iá»ƒn hÃ¬nh, thá»i Ä‘iá»ƒm ngÆ°á»i dÃ¹ng vÃ o web app, má»™t file `index.html` khÃ´ng cÃ³ ná»™i dung vÃ  file JS Ä‘Ã£ Ä‘Æ°á»£c bundle nÃ y sáº½ Ä‘Æ°á»£c client gá»i vá» qua network vÃ  load lÃªn.

![Code splitting demonstration](code-splitting-and-lazy-loading/image.png)

Má»¥c Ä‘Ã­ch cá»¥ thá»ƒ cá»§a technique code splitting lÃ  tÃ¡ch file lá»›n thÃ nh cÃ¡c file nhá», Ä‘á»ƒ cho phÃ©p client chá»‰ táº£i vá» nhá»¯ng bundle cáº§n thiáº¿t táº¡i thá»i Ä‘iá»ƒm Ä‘Ã³ thÃ´i, cÃ²n nhá»¯ng Ä‘oáº¡n code cÃ²n láº¡i sáº½ Ä‘Æ°á»£c táº£i on demand - mÃ  cÃ³ thá»ƒ lÃ  khi user scroll, interact hay chuyá»ƒn trang.

Code Ä‘Æ°á»£c split cÃ³ thá»ƒ lÃ  source code, JS, CSS, hoáº·c cáº£ nhá»¯ng third-party dependencies vÃ¢n vÃ¢n.

Tá»©c lÃ  á»Ÿ initial render á»Ÿ **casey.dev**, trang Home, hoáº·c tháº­m chÃ­ lÃ  chá»‰ pháº§n above the fold cá»§a Home cáº§n Ä‘Æ°á»£c hiá»ƒn thá»‹ nhanh nháº¥t cÃ³ thá»ƒ. Ta sáº½ tÃ¬m cÃ¡ch split Ä‘oáº¡n code cáº§n thiáº¿t cho pháº§n UI nÃ y riÃªng, dÃ¹ng webpack compile láº¡i thÃ nh main.bundle.js cháº³ng háº¡n, vÃ  cÃ¡c Ä‘oáº¡n code vÃ  dependencies cá»§a nhá»¯ng pháº§n khÃ¡c sáº½ Ä‘Æ°á»£c compile thÃ nh cÃ¡c file chunk-abc.bundle.js khÃ¡c.

Okay, technique chung chung lÃ  váº­y. Ká»¹ thuáº­t code splitting cÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng cho má»i web application, chá»© khÃ´ng dÃ nh riÃªng cho framework hay library nÃ o.

Tiáº¿p theo, cá»¥ thá»ƒ lÃ m tháº¿ nÃ o Ä‘á»ƒ split?

CÃ³ 2 cÃ¡ch:
- Entry point splitting: chia nhá» code thÃ nh nhiá»u entry points (tuy nhiÃªn trong quÃ¡ trÃ¬nh lÃ m viá»‡c mÃ¬nh chÆ°a bao giá» gáº·p trÆ°á»ng há»£p tá»‘t Ä‘á»ƒ sá»­ dá»¥ng entry point splitting, báº¡n Ä‘á»c cÃ³ kinh nghiá»‡m má»i chia sáº» nha!)
- Dynamic splitting: sá»­ dá»¥ng `dynamic import`
## Dynamic import
Dynamic import dÃ¹ng syntax `import()` thay vÃ¬ declaration `import A from "A.js"` nhÆ° bÃ¬nh thÆ°á»ng. CÃ¡ch import nÃ y load module 1 cÃ¡ch `async`. VÃ  Ä‘Ã¢y lÃ  má»™t ***tÃ­nh nÄƒng cá»§a Javascript*** nha.

Láº¥y má»™t vÃ­ dá»¥ tá»‘i giáº£n gá»“m 1 file html, trong Ä‘Ã³ embed JS file `index.js` nhÆ° sau:

![demonstration image](code-splitting-and-lazy-loading/image1.png)

`index.js`

![demonstration image](code-splitting-and-lazy-loading/image2.png)

Khi cháº¡y á»Ÿ browser, `data.js` tá»± Ä‘á»™ng Ä‘Æ°á»£c táº£i vá».

Giá» báº¡n tÆ°á»Ÿng tÆ°á»£ng code cá»§a mÃ¬nh sáº½ khÃ´ng chá»‰ cÃ³ 2 files `data` vÃ  `index` ná»¯a, mÃ  gá»“m hÃ ng trÄƒm files vÃ  dependencies khÃ¡c nhau. Táº¥t nhiÃªn khi báº­t app lÃªn, browser sáº½ Ä‘á»c `import` declaration tá»« file ná» sang file kia, vÃ  load háº¿t táº¥t cáº£ code vá» Ä‘Ãºng khÃ´ng?

Okie, váº­y thÃ¬ `dynamic import` sáº½ lÃ m khÃ¡c tháº¿ nÃ o.

MÃ¬nh sáº½ sá»­a `index.js` thÃ nh Ä‘oáº¡n code `dynamic import` tá»« file `data.js` khi ngÆ°á»i dÃ¹ng click vÃ o button.

![demonstration image](code-splitting-and-lazy-loading/image3.png)

![](screen-record1.mov)

Ok, váº­y lÃ  first load, web app cá»§a mÃ¬nh sáº½ chá»‰ pháº£i táº£i 2 files gá»n nháº¹ nháº¥t lÃ  `index.html` vÃ  `index.js` thÃ´i. Chá»‰ khi ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tÃ¡c vá»›i tÃ­nh nÄƒng nháº¥t Ä‘á»‹nh cá»§a app thÃ¬ nhá»¯ng Ä‘oáº¡n javascript cáº§n thiáº¿t má»›i Ä‘Æ°á»£c load vá» thÃªm. ÄÃ¢y chÃ­nh lÃ  yáº¿u tá»‘t ***on demand*** Ä‘Æ°á»£c nháº¯c Ä‘áº¿n phÃ­a trÃªn.

Cá»¥ thá»ƒ vá» API cá»§a syntax `import()` má»i báº¡n Ä‘á»c thÃªm [official document](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import) nhÃ©.

Háº§u háº¿t modern bundlers hiá»‡n nay (2024) nhÆ° webpack, rollup Ä‘á»u support code splitting khi source code sá»­ dá»¥ng dynamic import.

## Lazy loading
KhÃ¡c vá»›i dynamic import - má»™t tÃ­nh nÄƒng cá»§a Javascript, Lazy loading giá»‘ng vá»›i Code splitting lÃ  má»™t kÄ© thuáº­t cáº£i thiá»‡n performance cá»§a phÃ¡t triá»ƒn web.

CÆ¡ cháº¿ chÃ­nh cá»§a lazy load lÃ  viá»‡c delay láº¡i viá»‡c load cÃ¡c ná»™i dung website chÆ°a cáº§n hiá»ƒn thá»‹ trÃªn mÃ n hÃ¬nh cá»§a ngÆ°á»i dÃ¹ng.

Má»™t cÃ¡ch Ä‘á»ƒ lazy load lÃ  ta dÃ¹ng `dynamic import` - Ä‘á»ƒ load pháº§n ná»™i dung cá»§a trang web chá»‰ khi ngÆ°á»i dÃ¹ng scroll Ä‘áº¿n nÃ³. Má»™t vÃ­ dá»¥ cho cÃ¡ch nÃ y lÃ  hÃ m `lazy` trong React. Vá» báº£n cháº¥t, React cÅ©ng sá»­ dá»¥ng `dynamic import`, vÃ  do Ä‘Ã³ sáº½ Ä‘Æ°á»£c bundlers há»— trá»£ code splitting mÃ  thÃ´i.

CÃ¡ch phá»• biáº¿n ná»¯a lÃ  chÃºng ta lazy load áº£nh hoáº·c cÃ¡c assets náº·ng. LÃ m cÃ¡ch nÃ y ngÆ°á»i dÃ¹ng sáº½ nhÃ¬n tháº¥y pháº§n "khung" cá»§a web app trÆ°á»›c, rá»“i má»™t lÃºc sau áº£nh má»›i hiá»‡n ra. ÄÃ¢y lÃ  UX khÃ¡ phá»• biáº¿n vÃ¬ sáº½ cáº£i thiá»‡n tá»‘t First Contentful Pain, vÃ  cÃ³ thá»ƒ khiáº¿n user tÆ°Æ¡ng tÃ¡c vá»›i website ngay mÃ  khÃ´ng máº¥t thá»i gian chá» (ngÃ y nay khÃ¡ch pháº£i chá» 1 vÃ i giÃ¢y lÃ  táº¯t app liá»n ğŸ¥²)

![](screen-record2.mov)

Chá»‰ cÃ³ má»™t lÆ°u Ã½ nhá» khi dÃ¹ng Lazy loading lÃ  pháº£i chÃº Ã½ khÃ´ng Ä‘á»ƒ xáº£y ra Layout Shift - lá»—i khiáº¿n layout web bá»‹ xá»™c xá»‡ch Ä‘i khi má»™t pháº§n web má»›i Ä‘Æ°á»£c lazy load xong. Tai háº¡i nháº¥t lÃ  web bá»‹ cuá»‘n Ä‘i má»™t Ä‘oáº¡n Ä‘Ãºng lÃºc user Ä‘ang click, dáº«n Ä‘áº¿n click vÃ o sai element, gÃ¢y khÃ³ chá»‹u kinh khá»§ng ğŸ¥²
## TÃ³m láº¡i
Code splitting vÃ  Lazy loading lÃ  2 ká»¹ thuáº­t phá»• biáº¿n khi nÃ³i tá»›i web performance. ChÃºng cÃ³ cÆ¡ cháº¿ khÃ¡c nhau, nhÆ°ng trong ráº¥t nhiá»u trÆ°á»ng há»£p lÃ  bá»• trá»£ cho nhau Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u quáº£ mong muá»‘n.